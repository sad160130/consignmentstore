{% extends "base.html" %}

{% block meta %}
<meta name="description" content="Find the best consignment stores in {{ city.name }}, {{ state.name }}. Browse {{ city.store_count }} local thrift stores with ratings, reviews, and contact information.">
{% endblock %}

{% block title %}Consignment Stores in {{ city.name }}, {{ state.name }} | Local Thrift Store Directory{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Breadcrumb Navigation -->
    <nav class="text-sm mb-4" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li>
                <a href="{{ url_for('home') }}" class="text-blue-600 hover:text-blue-800">Home</a>
            </li>
            <li class="flex items-center">
                <svg class="h-3 w-3 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5.293 14.707a1 1 0 010-1.414L10.586 10 5.293 5.707a1 1 0 011.414-1.414l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0z"/>
                </svg>
                <a href="{{ url_for('state', state_name=state.slug) }}" class="ml-2 text-blue-600 hover:text-blue-800">
                    {{ state.name }}
                </a>
            </li>
            <li class="flex items-center">
                <svg class="h-3 w-3 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5.293 14.707a1 1 0 010-1.414L10.586 10 5.293 5.707a1 1 0 011.414-1.414l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0z"/>
                </svg>
                <span class="ml-2 text-gray-600">{{ city.name }}</span>
            </li>
        </ol>
    </nav>

    <!-- Page Header -->
    <header class="bg-white rounded-lg shadow-sm p-5 mb-6">
        <h1 class="text-2xl font-bold text-gray-900">
            Consignment Stores in {{ city.name }}, {{ state.name }}
        </h1>
        <p class="mt-1 text-gray-600">
            Discover {{ city.store_count }} local thrift and consignment stores
        </p>
    </header>

    <!-- Store Listings -->
    <div class="space-y-4 mb-8">
        {% for store in city.stores %}
        <article class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200">
            <div class="p-4">
                <div class="flex gap-4">
                    <!-- Store Information -->
                    <div class="flex-1 min-w-0">
                        <h2 class="text-lg font-semibold text-gray-900 mb-1">
                            {{ store.name }}
                        </h2>

                        <!-- Rating Display -->
                        {% if store.rating > 0 %}
                        <div class="flex items-center mb-2">
                            <div class="flex">
                                {% for i in range(5) %}
                                <svg class="w-4 h-4 {% if i < store.rating|int %}text-yellow-400{% else %}text-gray-300{% endif %}" 
                                     fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                {% endfor %}
                            </div>
                            <span class="ml-2 text-sm text-gray-600">
                                {{ "%.1f"|format(store.rating) }} ({{ store.review_count }} reviews)
                            </span>
                        </div>
                        {% endif %}

                        <!-- Store Address -->
                        <div class="flex items-start mb-2">
                            <svg class="w-4 h-4 text-gray-400 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                            <address class="not-italic text-sm text-gray-600">
                                {{ store.address }}
                            </address>
                        </div>

                        <!-- Store Description with Read More -->
                        {% if store.description_paragraphs %}
                        <div class="mb-3 relative">
                            <div class="text-sm text-gray-600">
                                <div id="shortDesc{{ loop.index }}" class="line-clamp-2">
                                    {{ store.description_paragraphs[0] }}
                                </div>
                                <div id="fullDesc{{ loop.index }}" class="hidden">
                                    {% for paragraph in store.description_paragraphs %}
                                    <p class="mb-2">{{ paragraph }}</p>
                                    {% endfor %}
                                </div>
                            </div>
                            <button onclick="toggleDescription({{ loop.index }})"
                                    id="readMoreBtn{{ loop.index }}"
                                    class="text-sm text-blue-600 hover:text-blue-800 mt-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 rounded-sm px-1">
                                Read more
                            </button>
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-2">
                            {% if store.phone %}
                            <a href="tel:{{ store.phone }}" 
                               class="inline-flex items-center px-3 py-1.5 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                                <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                Call Store
                            </a>
                            {% endif %}

                            {% if store.website %}
                            <a href="{{ store.website }}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               class="inline-flex items-center px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                                Visit Website
                            </a>
                            {% endif %}

                            <a href="https://www.google.com/maps/search/{{ store.name|urlencode }}+{{ store.address|urlencode }}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="inline-flex items-center px-3 py-1.5 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors">
                                <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                </svg>
                                Get Directions
                            </a>
                        </div>
                    </div>

                    <!-- Store Image -->
                    {% if store.photo %}
                    <div class="hidden sm:block flex-shrink-0">
                        <img src="{{ store.photo }}" 
                             alt="Photo of {{ store.name }}"
                             class="w-32 h-32 object-cover rounded-lg"
                             loading="lazy">
                    </div>
                    {% endif %}
                </div>
            </div>
        </article>
        {% endfor %}
    </div>

    <!-- Nearby Cities Section -->
    {% if nearby_cities %}
    <section class="bg-white rounded-lg shadow-sm p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">
            Nearby Cities in {{ state.name }}
        </h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
            {% for city in nearby_cities %}
            <a href="{{ url_for('city', state_name=state.slug, city_name=city.slug) }}" 
               class="block p-3 bg-gray-50 rounded hover:bg-gray-100 transition-colors">
                <h3 class="text-sm font-medium text-gray-900">{{ city.name }}</h3>
                <p class="text-xs text-gray-600 mt-0.5">
                    {{ city.store_count }} store{% if city.store_count != 1 %}s{% endif %}
                </p>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>

<!-- Required Styles -->
<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<!-- JavaScript for Read More functionality -->
<script>
function toggleDescription(index) {
    const shortDesc = document.getElementById(`shortDesc${index}`);
    const fullDesc = document.getElementById(`fullDesc${index}`);
    const button = document.getElementById(`readMoreBtn${index}`);
    
    if (fullDesc.classList.contains('hidden')) {
        // Show full description
        shortDesc.classList.add('hidden');
        fullDesc.classList.remove('hidden');
        button.textContent = 'Show less';
        
        // Smooth scroll to the full description
        fullDesc.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        // Show short description
        shortDesc.classList.remove('hidden');
        fullDesc.classList.add('hidden');
        button.textContent = 'Read more';
        
        // Smooth scroll back to the store card
        shortDesc.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}
</script>
{% endblock %}